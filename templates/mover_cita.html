<!-- templates/mover_cita.html -->
{% extends "admin_layout.html" %}

{% block title %}Mover Cita{% endblock %}

{% block content %}
  <div class="bg-white p-6 rounded-2xl shadow-xl w-full max-w-lg mx-auto">
    <h2 class="text-xl font-bold mb-2 text-center text-gray-800">Mover Cita</h2>

    <!-- Información del paciente -->
    <div class="bg-gray-50 p-4 rounded-lg mb-6 text-center">
      <p class="text-gray-700">Paciente: <strong class="font-semibold">{{ cita.nombre }}</strong></p>
      <p class="text-gray-500 text-sm">Fecha Actual: {{ cita.fecha }}</p>
    </div>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="mb-4">
          {% for category, message in messages %}
            <div class="p-3 rounded {% if category == 'success' %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <form method="POST" class="space-y-4">
      <div>
        <label for="nueva_fecha" class="block text-gray-700 mb-1">Nueva Fecha para la Cita</label>
        <input type="date" id="nueva_fecha" name="nueva_fecha" required
          class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
      </div>
      
      <div class="flex gap-4">
        <a href="{{ url_for('admin') }}" class="w-full text-center bg-gray-300 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-400 transition">
          Cancelar
        </a>
        <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition">
          Mover Cita
        </button>
      </div>
    </form>
  </div>

  <!-- Pop-up de error (igual que en el formulario principal) -->
  <div id="error-popup" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm text-center">
      <h3 class="text-lg font-bold text-gray-800 mt-4">Fecha no disponible</h3>
      <p id="popup-message" class="text-gray-600 my-2"></p>
      <button id="close-popup-btn" class="mt-4 w-full bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition">
        Entendido
      </button>
    </div>
  </div>

  <script>
    const blockedDates = {{ fechas_bloqueadas|tojson }};
    const dateInput = document.getElementById('nueva_fecha');
    const errorPopup = document.getElementById('error-popup');
    const popupMessage = document.getElementById('popup-message');
    const closePopupButton = document.getElementById('close-popup-btn');

    function showPopup(message) {
      popupMessage.textContent = message;
      errorPopup.classList.remove('hidden');
    }

    function hidePopup() {
      errorPopup.classList.add('hidden');
    }

    dateInput.addEventListener('change', function() {
      const selectedDate = this.value;
      if (blockedDates.includes(selectedDate)) {
        const [year, month, day] = selectedDate.split('-');
        const formattedDate = `${day}/${month}/${year}`;
        const message = `La fecha ${formattedDate} está bloqueada. Por favor, seleccione otra.`;
        showPopup(message);
        this.value = '';
      }
    });

    closePopupButton.addEventListener('click', hidePopup);
    errorPopup.addEventListener('click', (event) => {
      if (event.target === errorPopup) hidePopup();
    });
  </script>
{% endblock %}
<!-- templates/sala_unificada.html (VERSI√ìN CON BOT√ìN RE-LLAMAR) -->
{% extends "sala_layout.html" %}

{% block title %}Sala de Llamadas{% endblock %}

{% block content %}
<!-- PANTALLA DE INICIO (sin cambios) -->
<div id="pantalla-inicio" class="text-center">
  <h1 class="text-3xl font-bold mb-4">Sistema de Anuncios</h1>
  <p class="text-lg text-gray-600 mb-8">Presione el bot√≥n para activar la sala de espera.</p>
  <button id="btn-activar" class="bg-green-600 text-white font-bold py-4 px-8 rounded-lg text-2xl shadow-lg hover:bg-green-700 transition">
    ‚ñ∂ Iniciar Conexi√≥n
  </button>
</div>

<!-- CONTENIDO PRINCIPAL (Inicialmente oculto) -->
<div id="contenido-principal" class="hidden">
  <h1 class="text-3xl font-bold mb-6">üó£Ô∏è Sala de Llamadas y Anuncios</h1>
  {% if es_doctor %}
  <div id="panel-doctora" class="mb-8">
    <!-- Panel de filtro (sin cambios) -->
    <div class="bg-white shadow-md rounded-lg p-4 mb-6">
      <h3 class="font-semibold text-lg mb-3">Filtrar Pacientes por Fecha</h3>
      <form method="GET" action="{{ url_for('sala_unificada') }}" class="flex flex-wrap items-end gap-4">
        <div>
          <label for="fecha-filtro" class="block text-sm font-medium text-gray-700 mb-1">Citas del d√≠a:</label>
          <input type="date" id="fecha-filtro" name="fecha" value="{{ filtro_fecha }}" class="border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
        </div>
        <button type="submit" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition">
          Ver Pacientes
        </button>
      </form>
    </div>
    <!-- Lista de pacientes -->
    <div class="bg-white shadow-md rounded-lg p-4">
      <h2 class="text-xl font-semibold mb-4">üë• Pacientes para el {{ filtro_fecha }}</h2>
      <div class="space-y-3">
        {% for cita in citas %}
        <div class="flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50">
          <div class="flex items-center gap-3">
            <input type="checkbox" id="llamado-{{ cita.id }}" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500" disabled {% if cita.fue_llamado %}checked{% endif %}>
            <span class="font-medium text-gray-800">{{ cita.nombre }}</span>
          </div>

          <!-- AVISO: CAMBIO 1 DE 2 - El bot√≥n ahora tiene un estado inicial diferente si ya fue llamado -->
          {% if cita.fue_llamado %}
            <button onclick="anunciarLlamada('{{ cita.id }}', '{{ cita.nombre }}', this)" class="bg-gray-500 text-white py-1 px-4 rounded-md hover:bg-gray-600 transition text-sm">
              Llamar de Nuevo
            </button>
          {% else %}
            <button onclick="anunciarLlamada('{{ cita.id }}', '{{ cita.nombre }}', this)" class="bg-green-500 text-white py-1 px-4 rounded-md hover:bg-green-600 transition text-sm">
              Llamar
            </button>
          {% endif %}
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}
  <!-- Panel de anuncios (sin cambios) -->
  <div id="panel-anuncios" class="bg-white p-6 rounded-lg shadow-md max-w-md mx-auto text-center">
      <div id="status-indicator" class="w-4 h-4 rounded-full bg-yellow-400 animate-pulse inline-block"></div>
      <p id="status-text" class="inline-block ml-2 font-semibold text-gray-700">Conectando al servidor...</p>
      <div class="mt-4 p-4 bg-gray-100 rounded">
          <h3 class="font-bold text-lg">√öltimo paciente llamado:</h3>
          <p id="last-called" class="text-2xl text-blue-600 mt-2">‚Äî</p>
      </div>
  </div>
</div>

<script>
  // ... (toda la l√≥gica de activaci√≥n y conexi√≥n `iniciarSistema` se queda exactamente igual) ...
  const btnActivar = document.getElementById('btn-activar');
  const pantallaInicio = document.getElementById('pantalla-inicio');
  const contenidoPrincipal = document.getElementById('contenido-principal');
  const esDoctor = {{ es_doctor|tojson }};

  function anunciarPaciente(nombre) {
    if ('speechSynthesis' in window) {
      window.speechSynthesis.cancel();
      const utterance = new SpeechSynthesisUtterance(nombre + ", por favor, pasar al consultorio de la doctora Jennifer Reyes");
      utterance.lang = 'es-MX';
      utterance.rate = 0.9;
      window.speechSynthesis.speak(utterance);
    }
  }

  function iniciarSistema() {
    pantallaInicio.style.display = 'none';
    contenidoPrincipal.classList.remove('hidden');
    if (!esDoctor && 'speechSynthesis' in window) {
      const warmUpUtterance = new SpeechSynthesisUtterance("Sistema de anuncios activado.");
      warmUpUtterance.volume = 0.1;
      warmUpUtterance.lang = 'es-MX';
      window.speechSynthesis.speak(warmUpUtterance);
    }
    const eventSource = new EventSource("{{ url_for('stream') }}");
    const statusIndicator = document.getElementById('status-indicator');
    const statusText = document.getElementById('status-text');
    const lastCalled = document.getElementById('last-called');
    eventSource.onopen = function() {
      statusIndicator.classList.remove('bg-yellow-400', 'bg-red-500', 'animate-pulse');
      statusIndicator.classList.add('bg-green-500');
      statusText.textContent = 'Conectado. Escuchando anuncios...';
    };
    eventSource.onmessage = function(event) {
      const nombrePaciente = event.data;
      lastCalled.textContent = nombrePaciente;
      anunciarPaciente(nombrePaciente);
    };
    eventSource.onerror = function(err) {
      statusIndicator.classList.remove('bg-yellow-400', 'bg-green-500');
      statusIndicator.classList.add('bg-red-500', 'animate-pulse');
      statusText.textContent = 'Error de conexi√≥n. Intentando reconectar...';
    };
  }

  if (esDoctor) { iniciarSistema(); } 
  else { btnActivar.addEventListener('click', iniciarSistema); }

  async function anunciarLlamada(citaId, nombre, buttonElement) {
    buttonElement.disabled = true;
    buttonElement.textContent = 'Llamando...';
    buttonElement.classList.add('opacity-50', 'cursor-not-allowed');
    try {
      const response = await fetch("{{ url_for('llamar_y_marcar') }}", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ citaId: citaId, nombre: nombre }),
      });
      const result = await response.json();
      if (!result.success) throw new Error(result.error || 'Error del servidor');

      document.getElementById(`llamado-${citaId}`).checked = true;
      buttonElement.textContent = 'Llamado ‚úì';
      // Cambiamos el color a azul para la confirmaci√≥n visual
      buttonElement.classList.remove('bg-green-500', 'bg-gray-500'); 
      buttonElement.classList.add('bg-blue-500');

      // AVISO: CAMBIO 2 DE 2 - Usamos setTimeout para reactivar el bot√≥n despu√©s de 2 segundos.
      setTimeout(() => {
        buttonElement.disabled = false;
        buttonElement.textContent = 'Llamar de Nuevo';
        // Lo devolvemos a un color secundario (gris) y quitamos los estilos de "deshabilitado"
        buttonElement.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-blue-500');
        buttonElement.classList.add('bg-gray-500');
      }, 2000); // 2000 milisegundos = 2 segundos

    } catch (error) {
      console.error(error);
      alert('Hubo un error al llamar al paciente.');
      
      // L√≥gica de error mejorada para restaurar el estado correcto del bot√≥n
      buttonElement.disabled = false;
      const checkbox = document.getElementById(`llamado-${citaId}`);
      if (checkbox && checkbox.checked) {
        buttonElement.textContent = 'Llamar de Nuevo';
        buttonElement.classList.remove('opacity-50', 'cursor-not-allowed');
        buttonElement.classList.add('bg-gray-500');
      } else {
        buttonElement.textContent = 'Llamar';
        buttonElement.classList.remove('opacity-50', 'cursor-not-allowed');
        buttonElement.classList.add('bg-green-500');
      }
    }
  }
</script>
{% endblock %}